<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç»™æ˜ç ï½œæ–°å¹´çƒŸèŠ±ä¸æ˜Ÿæ²³</title>
  <style>
    :root{
      --bg0:#03040b;
      --bg1:#070b22;
      --bg2:#111a4b;
      --bg3:#2a0b3a;
      --gold:#ffd37a;
      --pink:#ff63c6;
      --cyan:#6bf7ff;
      --mint:#7fffd4;
      --white:#ffffff;
      --glass: rgba(10, 14, 35, .42);
      --stroke: rgba(255,255,255,.16);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; overflow:hidden; background:#000;}
    body{
      font-family: -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#fff;
      user-select:none;
    }

    /* èƒŒæ™¯ï¼šæ˜Ÿäº‘ */
    .bg{
      position:fixed; inset:0; z-index:0;
      background:
        radial-gradient(1200px 900px at 20% 18%, rgba(255,99,198,.18) 0%, transparent 58%),
        radial-gradient(1100px 900px at 80% 28%, rgba(107,247,255,.13) 0%, transparent 60%),
        radial-gradient(900px 700px at 55% 92%, rgba(255,211,122,.10) 0%, transparent 60%),
        linear-gradient(160deg, var(--bg0), var(--bg1) 35%, var(--bg2) 62%, var(--bg3));
      filter:saturate(1.12);
    }

    /* ç”µå½±é¢—ç²’ */
    .grain{
      position:fixed; inset:-30%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.16;
      z-index:2;
      pointer-events:none;
      animation: grainMove 7s steps(10) infinite;
    }
    @keyframes grainMove{
      0%{transform:translate(0,0)}
      20%{transform:translate(-4%,2%)}
      40%{transform:translate(3%,-3%)}
      60%{transform:translate(-2%,-1%)}
      80%{transform:translate(2%,4%)}
      100%{transform:translate(0,0)}
    }

    /* æ˜Ÿç‚¹å±‚ */
    .stars{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 18% 20%, rgba(255,255,255,.75) 40%, transparent 41%),
        radial-gradient(1.6px 1.6px at 72% 22%, rgba(255,255,255,.55) 40%, transparent 41%),
        radial-gradient(1.4px 1.4px at 42% 76%, rgba(255,255,255,.52) 40%, transparent 41%),
        radial-gradient(1.2px 1.2px at 84% 68%, rgba(255,255,255,.45) 40%, transparent 41%),
        radial-gradient(1px 1px at 12% 84%, rgba(255,255,255,.40) 40%, transparent 41%),
        radial-gradient(1px 1px at 55% 35%, rgba(255,255,255,.35) 40%, transparent 41%),
        radial-gradient(1px 1px at 30% 55%, rgba(255,255,255,.33) 40%, transparent 41%),
        radial-gradient(1px 1px at 90% 45%, rgba(255,255,255,.28) 40%, transparent 41%);
      opacity:.75;
      animation: twinkle 4.2s ease-in-out infinite;
    }
    @keyframes twinkle{ 0%,100%{opacity:.55} 50%{opacity:.95} }

    /* è§†é¢‘å±‚ï¼šå¯é€‰â€œå¹½å¹½åŠ¨æ€èƒŒæ™¯â€ï¼Œé»˜è®¤éšè—ï¼ŒæŒ‰é’®æ‰“å¼€æ—¶æ˜¾ç¤º */
    .bgVideo{
      position:fixed; inset:0;
      width:100vw; height:100vh; object-fit:cover;
      z-index:0;
      opacity:.0;
      transform: scale(1.02);
      filter: blur(3px) saturate(1.05) contrast(1.05);
      mix-blend-mode: screen;
      pointer-events:none;
      transition: opacity .7s ease;
    }
    .bgVideo.on{ opacity:.25; }

    /* Canvasï¼šæµæ˜Ÿä¸çƒŸèŠ±ï¼ˆä¸¤å±‚ï¼‰ */
    canvas{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      z-index:3;
    }
    #meteors{ z-index:2; }
    #fireworks{ z-index:3; }

    /* ä¸­å¤®æ–‡æ¡ˆå±‚ */
    .center{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:4;
      pointer-events:none;
      padding: 22px;
      text-align:center;
    }
    .stack{ max-width:min(920px, 92vw); }

    .badgeRow{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .badge{
      pointer-events:none;
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      opacity:.88;
    }

    .title{
      margin:0;
      font-weight: 950;
      letter-spacing: 2px;
      font-size: clamp(36px, 6vw, 78px);
      line-height:1.05;
      background: linear-gradient(90deg, #fff, var(--gold), var(--pink));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      text-shadow:
        0 0 30px rgba(255,211,122,.14),
        0 0 80px rgba(255,99,198,.10);
      position:relative;
      animation: breathe 2.8s ease-in-out infinite;
    }
    @keyframes breathe{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.02); }
    }

    /* â€œæè¾¹éœ“è™¹â€è®©æ–‡å­—ä¸å•è°ƒ */
    .title::after{
      content: attr(data-glow);
      position:absolute; left:0; right:0; top:0;
      color: transparent;
      -webkit-text-stroke: 2px rgba(255,255,255,.22);
      filter: drop-shadow(0 0 18px rgba(107,247,255,.14));
      opacity:.75;
      transform: translateY(2px);
      z-index:-1;
    }

    .poem{
      margin: 16px auto 0;
      font-size: clamp(14px, 2.2vw, 18px);
      line-height:1.85;
      opacity:.92;
      text-shadow: 0 12px 45px rgba(0,0,0,.35);
    }
    .poem .line{
      display:block;
      opacity:0;
      transform: translateY(10px);
      animation: riseIn .9s ease forwards;
    }
    .poem .line:nth-child(1){ animation-delay: .25s; }
    .poem .line:nth-child(2){ animation-delay: .55s; }
    .poem .line:nth-child(3){ animation-delay: .85s; }
    .poem .line:nth-child(4){ animation-delay: 1.15s; }
    @keyframes riseIn{
      to{ opacity:1; transform: translateY(0); }
    }

    /* ç…§ç‰‡å¡ç‰‡ï¼šåƒæ‹ç«‹å¾—ä¸€æ ·æ¼‚æµ®ï¼ˆå¯ç‚¹ï¼‰ */
    .photos{
      position:fixed;
      left: 18px;
      top: 18px;
      z-index:5;
      display:flex;
      flex-direction:column;
      gap:12px;
      pointer-events:auto;
    }
    .photoCard{
      width: 118px;
      border-radius: 16px;
      padding: 10px;
      background: rgba(10,14,35,.38);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      cursor:pointer;
      transform: rotate(-2deg);
      transition: transform .18s ease, border-color .18s ease;
    }
    .photoCard:nth-child(2){ transform: rotate(2deg); }
    .photoCard:active{ transform: scale(.98); }
    .photo{
      width:100%;
      height: 110px;
      border-radius: 12px;
      object-fit: cover;
      display:block;
      filter: contrast(1.05) saturate(1.05);
    }
    .cap{
      margin-top: 8px;
      font-size: 11px;
      opacity:.82;
      line-height:1.35;
    }

    /* åº•éƒ¨ HUD */
    .hud{
      position:fixed; left:0; right:0; bottom:0;
      z-index:6;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      display:flex; justify-content:center;
      pointer-events:none;
    }
    .bar{
      width:min(860px, 96vw);
      display:flex;
      gap:10px;
      padding: 10px;
      border-radius: 18px;
      background: var(--glass);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(14px);
      box-shadow: 0 22px 90px rgba(0,0,0,.35);
      pointer-events:auto;
      flex-wrap:wrap;
    }
    button{
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      font-weight:900;
      cursor:pointer;
      color:#061027;
      transition: transform .08s ease;
      flex: 1 1 170px;
    }
    button:active{ transform: scale(.98); }
    .btnGold{
      background: linear-gradient(90deg, var(--gold), #fff);
      box-shadow: 0 10px 30px rgba(255,211,122,.12);
    }
    .btnCyan{
      background: linear-gradient(90deg, var(--cyan), #fff);
      box-shadow: 0 10px 30px rgba(107,247,255,.10);
    }
    .btnPink{
      background: linear-gradient(90deg, var(--pink), #fff);
      box-shadow: 0 10px 30px rgba(255,99,198,.10);
    }

    .tip{
      position:fixed;
      z-index:6;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
      font-size: 12px;
      opacity:.86;
      pointer-events:none;
      transition: opacity .8s ease;
    }

    /* è§†é¢‘ Modalï¼ˆèåˆï¼‰ */
    .modal{
      position:fixed; inset:0; z-index:9;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .modal.on{ display:flex; }
    .modalBox{
      width:min(980px, 96vw);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,14,35,.40);
      box-shadow: 0 24px 120px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size: 13px;
      opacity:.9;
    }
    .x{
      border:0; cursor:pointer; font-weight:900;
      background: rgba(255,255,255,.12);
      color:#fff;
      padding: 8px 12px;
      border-radius: 999px;
    }
    .modalVideo{
      width:100%;
      max-height: 72vh;
      display:block;
      object-fit:cover;
      background:#000;
    }
    .modalNote{
      padding: 12px 14px 14px;
      font-size: 13px;
      opacity:.86;
      line-height:1.7;
    }

    /* å°å±ä¼˜åŒ–ï¼šç…§ç‰‡å¡ä¸è¦æŒ¡å¤ªå¤š */
    @media (max-width: 420px){
      .photos{ left: 10px; top: 10px; }
      .photoCard{ width: 104px; }
      .photo{ height: 98px; }
    }
  </style>
</head>
<body>
  <div class="bg"></div>
  <video id="bgVideo" class="bgVideo" muted playsinline preload="metadata"></video>
  <div class="stars"></div>
  <canvas id="meteors"></canvas>
  <canvas id="fireworks"></canvas>
  <div class="grain"></div>

  <div class="tip" id="tip">ç‚¹å±å¹•æ”¾çƒŸèŠ±ï½œé•¿æŒ‰æ›´å¯†é›†ï½œç‚¹å·¦ä¸Šç…§ç‰‡ä¼šè§¦å‘â€œç…§ç‰‡çƒŸèŠ±â€</div>

  <!-- å·¦ä¸Šè§’ç…§ç‰‡å¡ï¼ˆèåˆå…¥å£ä¹‹ä¸€ï¼‰ -->
  <div class="photos">
    <div class="photoCard" id="p1">
      <img class="photo" id="img1" alt="æ˜ç ç…§ç‰‡1">
      <div class="cap">æŠŠæ¸©æŸ”è—è¿›å…‰é‡Œ<br/>ï¼ˆç‚¹æˆ‘ï¼‰</div>
    </div>
    <div class="photoCard" id="p2">
      <img class="photo" id="img2" alt="æ˜ç ç…§ç‰‡2">
      <div class="cap">æŠŠå¹¸ç¦ç«¯åœ¨æ‰‹å¿ƒ<br/>ï¼ˆç‚¹æˆ‘ï¼‰</div>
    </div>
  </div>

  <!-- ä¸­å¤®æ–‡æ¡ˆï¼šèµ°å¿ƒ + åˆ†è¡Œå…¥åœº -->
  <div class="center">
    <div class="stack">
      <div class="badgeRow">
        <div class="badge" id="yearBadge">âœ¨ æ–°å¹´ Â· æ˜Ÿæ²³ä¸ºä½ äº®</div>
        <div class="badge">ä¸“å±å¯¹è±¡ï¼š<b id="nameBadge">æ˜ç </b></div>
        <div class="badge">æç¤ºï¼šå¼€å¯éŸ³æ•ˆæ›´æ²‰æµ¸</div>
      </div>

      <h1 class="title" id="title" data-glow="æ˜ç ï¼Œæ–°å¹´å¿«ä¹">æ˜ç ï¼Œæ–°å¹´å¿«ä¹</h1>

      <div class="poem" id="poem">
        <span class="line">æ„¿ä½ è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…ï¼Œä¹Ÿè¢«è‡ªå·±åšå®šåçˆ±ã€‚</span>
        <span class="line">æ„¿ä½ åœ¨æ¯ä¸ªæ™®é€šçš„æ—¥å­é‡Œï¼Œéƒ½èƒ½æ”¶è·å¾®å°è€Œç¡®å‡¿çš„å¹¸ç¦ã€‚</span>
        <span class="line">æ„¿ä½ ä¸å¿…é€å¼ºä¹Ÿèƒ½è¢«ç†è§£ï¼Œä¸å¿…è®¨å¥½ä¹Ÿèƒ½è¢«çæƒœã€‚</span>
        <span class="line">è¿™ä¸€å¹´ï¼Œå¸Œæœ›ä½ çš„æ„ŸåŠ¨ç¾å¥½éƒ½å…·è±¡åŒ–ã€‚</span>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æ“ä½œ -->
  <div class="hud">
    <div class="bar">
      <button class="btnGold" id="mega">ğŸ† è¶…çº§è¿å‘</button>
      <button class="btnCyan" id="wish">âœ¨ æ¢ä¸€å¥èµ°å¿ƒç¥ç¦</button>
      <button class="btnPink" id="sound">ğŸ”Š å¼€å¯éŸ³æ•ˆ</button>
      <button class="btnCyan" id="videoBtn">ğŸ¬ æ‰“å¼€è§†é¢‘å›å¿†</button>
    </div>
  </div>

  <!-- è§†é¢‘å¼¹çª— -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalTop">
        <div>ğŸ¬ ç»™æ˜ç çš„ç‰‡æ®µï½œç‚¹å³ä¾§å…³é—­</div>
        <button class="x" id="close">å…³é—­</button>
      </div>
      <video id="mv" class="modalVideo" controls playsinline preload="metadata"></video>
      <div class="modalNote" id="modalNote">
        ä½ çš„å›å¿†è‡ªå·±çœ‹å“ˆå“ˆå“ˆã€‚<br/>
        çœ‹å®Œå¯ä»¥å†ç‚¹ä¸€æ¬¡ã€Œè¶…çº§è¿å‘ã€ï¼ŒæŠŠè¿™ä¸€åˆ»ç‚¹äº®åˆ°æè‡´ã€‚
      </div>
    </div>
  </div>

<script>
/* ==========================
   0) ä½ åªéœ€è¦æ”¹è¿™é‡Œçš„æ–‡å­—
========================== */
const HER_NAME = "æ˜ç ";           // âœ… ç¥ç¦å¯¹è±¡
const FROM_NAME = "";             // ä¾‹å¦‚ï¼š"â€”â€” MING"ï¼ˆå¯ç•™ç©ºï¼‰
const ASSETS = {
  img1: "assets/mingzhu1.jpg",
  img2: "assets/mingzhu2.jpg",
  video: "assets/mingzhu.mp4",
};

/* èµ°å¿ƒæ–‡æ¡ˆæ± ï¼ˆæ›´æœ‰å±‚æ¬¡ï¼Œä¸å•è°ƒï¼‰ */
const WISHES = [
  ["æ„¿ä½ è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…ï¼Œä¹Ÿè¢«è‡ªå·±åšå®šåçˆ±ã€‚","æ„¿ä½ åœ¨æ™®é€šæ—¥å­é‡Œä¹Ÿèƒ½æ”¶è·å¾®å°å´ç¡®å‡¿çš„å¹¸ç¦ã€‚","æ„¿ä½ ä¸å¿…é€å¼ºä¹Ÿèƒ½è¢«ç†è§£ï¼Œä¸å¿…è®¨å¥½ä¹Ÿèƒ½è¢«çæƒœã€‚","å¿«å¿«ä¹ä¹ï¼Œè¶Šæ¥è¶Šç¾ã€‚"],
  ["æ„¿ä½ æ€»èƒ½åœ¨ä½è°·é‡Œé‡è§å…‰ï¼Œåœ¨å¿™ç¢Œé‡Œç•™ä½å¿ƒè·³ã€‚","æ„¿ä½ æŠŠç”Ÿæ´»è¿‡æˆä½ å–œæ¬¢çš„æ ·å­ï¼Œä¸æ…Œä¸å¿™ï¼Œå´åšå®šå‘å‰ã€‚","æ„¿ä½ è¢«åçˆ±æ—¶ä¸æƒ¶æï¼Œè¢«ç‹¬å¤„æ—¶ä¸å­¤å•ã€‚","å¹³å®‰å–œä¹ï¼Œç¿çƒ‚åƒé˜³ã€‚"],
  ["æ„¿ä½ ç¬‘èµ·æ¥çš„æ—¶å€™ï¼Œä¸–ç•Œä¹Ÿè·Ÿç€å˜æŸ”è½¯ã€‚","æ„¿ä½ æ‰€æœ‰çš„è®¤çœŸéƒ½è¢«çœ‹è§ï¼Œæ‰€æœ‰çš„æœŸå¾…éƒ½æœ‰å›å“ã€‚","æ„¿ä½ è¢«åšå®šé€‰æ‹©ï¼Œè¢«æ¸©æŸ”æ‹¥æŠ±ï¼Œè¢«å¹¸è¿åè¢’ã€‚","æ–°çš„ä¸€å¹´ï¼Œå¼€å¼€å¿ƒå¿ƒã€‚"],
  ["æ„¿ä½ æ‹¥æœ‰è¶³å¤Ÿçš„è‡ªç”±ï¼Œä¹Ÿæ‹¥æœ‰è¢«å®ˆæŠ¤çš„å®‰å¿ƒã€‚","æ„¿ä½ åœ¨ä»»ä½•å…³ç³»é‡Œéƒ½ä¸å§”å±ˆè‡ªå·±ï¼Œåœ¨ä»»ä½•é€‰æ‹©é‡Œéƒ½ä¸è¾œè´ŸçœŸå¿ƒã€‚","æ„¿ä½ æ¯ä¸€æ¬¡å‘å‰ï¼Œéƒ½æ°å¥½é‡åˆ°æ›´å¥½çš„è‡ªå·±ã€‚","å¹³å‡¡æ—¥å­ï¼Œæ¸©æŸ”æµªæ¼«ã€‚"],
];

const FLOAT_QUOTES = [
  "æ˜ç ï¼Œæ–°å¹´å¿«ä¹",
  "æ„¿ä½ é—ªé—ªå‘å…‰",
  "æ„¿ä½ è¢«æ¸©æŸ”åšå®šé€‰æ‹©",
  "æ„¿ä½ å¿ƒæƒ³äº‹æˆ",
  "æ„¿ä½ æ¯å¤©éƒ½å¿«ä¹ä¸€ç‚¹",
];

/* ==========================
   1) DOM åˆå§‹åŒ–
========================== */
const $ = s => document.querySelector(s);
$("#nameBadge").textContent = HER_NAME;
$("#title").textContent = `${HER_NAME}ï¼Œæ–°å¹´å¿«ä¹`;
$("#title").setAttribute("data-glow", `${HER_NAME}ï¼Œæ–°å¹´å¿«ä¹`);
$("#yearBadge").textContent = `âœ¨ ${new Date().getFullYear()} Â· æ˜Ÿæ²³ä¸ºä½ äº®`;

const img1 = $("#img1"), img2 = $("#img2");
img1.src = ASSETS.img1; img2.src = ASSETS.img2;

const bgVideo = $("#bgVideo");
bgVideo.src = ASSETS.video;  // èƒŒæ™¯è§†é¢‘ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰

const modal = $("#modal");
const mv = $("#mv");
mv.src = ASSETS.video;

/* ==========================
   2) éŸ³æ•ˆï¼ˆç‚¹å‡»åæ‰å¯æ’­æ”¾ï¼‰
   - WebAudio å°é“ƒå£° + çƒŸèŠ±â€œå•ªâ€å£°
========================== */
let audioOn = false;
let ac = null;

function ensureAudio(){
  if(ac) return;
  ac = new (window.AudioContext || window.webkitAudioContext)();
}

function ping(freq=880, dur=0.08, gain=0.08){
  if(!audioOn) return;
  ensureAudio();
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  g.gain.value = 0.0001;
  o.connect(g).connect(ac.destination);
  const t = ac.currentTime;
  g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  o.start(t);
  o.stop(t + dur + 0.02);
}

function boomSound(){
  if(!audioOn) return;
  ensureAudio();
  // å™ªå£° + çŸ­åŒ…ç»œ
  const bufferSize = 2 * ac.sampleRate;
  const noiseBuffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

  const noise = ac.createBufferSource();
  noise.buffer = noiseBuffer;

  const filter = ac.createBiquadFilter();
  filter.type = "bandpass";
  filter.frequency.value = 180;

  const gainNode = ac.createGain();
  gainNode.gain.value = 0.0001;

  noise.connect(filter).connect(gainNode).connect(ac.destination);

  const t = ac.currentTime;
  gainNode.gain.exponentialRampToValueAtTime(0.12, t + 0.01);
  gainNode.gain.exponentialRampToValueAtTime(0.0001, t + 0.20);

  noise.start(t);
  noise.stop(t + 0.22);
}

$("#sound").addEventListener("click", async ()=>{
  audioOn = !audioOn;
  if(audioOn){
    ensureAudio();
    try{ await ac.resume(); }catch(e){}
    $("#sound").textContent = "ğŸ”Š éŸ³æ•ˆå·²å¼€å¯";
    ping(1046, 0.10, 0.10); setTimeout(()=>ping(1318,0.10,0.09),120);
  }else{
    $("#sound").textContent = "ğŸ”ˆ å…³é—­éŸ³æ•ˆ";
  }
});

/* ==========================
   3) æ–‡æ¡ˆæ¢ä¸€å¥—ï¼ˆåˆ†è¡Œå…¥åœºæ›´èµ°å¿ƒï¼‰
========================== */
function setPoem(lines){
  const poem = $("#poem");
  poem.innerHTML = "";
  lines.forEach((t,i)=>{
    const s = document.createElement("span");
    s.className = "line";
    s.textContent = t + (i===lines.length-1 && FROM_NAME ? ` ${FROM_NAME}` : "");
    s.style.animationDelay = (0.25 + i*0.28) + "s";
    poem.appendChild(s);
  });
}

$("#wish").addEventListener("click", ()=>{
  setPoem(WISHES[(Math.random()*WISHES.length)|0]);
  megaBurst(isMobile ? 16 : 22);
  floatText(pick(FLOAT_QUOTES), W*0.5, H*0.42);
  ping(988,0.08,0.08); setTimeout(()=>ping(1175,0.08,0.07),120);
});

/* ==========================
   4) è§†é¢‘èåˆï¼šå¼¹çª— + èƒŒæ™¯å¹½å…‰
========================== */
$("#videoBtn").addEventListener("click", ()=>{
  modal.classList.add("on");
  bgVideo.classList.add("on");
  // iOS/å¾®ä¿¡ï¼šè‡ªåŠ¨æ’­æ”¾é€šå¸¸é™åˆ¶ï¼Œå°½é‡å°è¯•é™éŸ³æ’­æ”¾ï¼ˆå…è®¸æ¦‚ç‡æ›´é«˜ï¼‰
  try{ bgVideo.muted = true; bgVideo.play(); }catch(e){}
  try{ mv.play(); }catch(e){}
  megaBurst(isMobile ? 12 : 16);
  floatText("è¿™ä¸€æ®µå›å¿†ï¼Œé€ç»™ä½ ", W*0.5, H*0.42);
});

$("#close").addEventListener("click", ()=>{
  modal.classList.remove("on");
  bgVideo.classList.remove("on");
  try{ mv.pause(); }catch(e){}
});

/* ==========================
   5) Canvas å°ºå¯¸
========================== */
const meteors = $("#meteors");
const fireworks = $("#fireworks");
const mctx = meteors.getContext("2d", { alpha:true });
const fctx = fireworks.getContext("2d", { alpha:true });

let W=0,H=0,DPR=1;
function resize(){
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = Math.floor(innerWidth);
  H = Math.floor(innerHeight);
  [meteors, fireworks].forEach(c=>{
    c.width = Math.floor(W * DPR);
    c.height = Math.floor(H * DPR);
    c.style.width = W+"px";
    c.style.height = H+"px";
  });
  mctx.setTransform(DPR,0,0,DPR,0,0);
  fctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", resize);
resize();

const isMobile = matchMedia("(pointer:coarse)").matches;

/* ==========================
   6) æµæ˜Ÿé›¨ï¼ˆèƒŒæ™¯å±‚ï¼‰
========================== */
const meteorList = [];
function spawnMeteor(){
  // ä»ä¸Šæ–¹éšæœºè¿›å…¥ï¼Œæ–œå‘å³ä¸‹
  const x = rand(-W*0.2, W*0.9);
  const y = rand(-H*0.2, H*0.35);
  meteorList.push({
    x,y,
    vx: rand(10, 16),
    vy: rand(6, 10),
    life: 0,
    max: rand(24, 44),
    w: rand(120, 220),
  });
}
let meteorTimer = 0;

function meteorLoop(ts){
  // è½»å¾®æ‹–å½±
  mctx.fillStyle = "rgba(0,0,0,0.18)";
  mctx.fillRect(0,0,W,H);

  if(ts - meteorTimer > (isMobile ? 520 : 420)){
    if(Math.random() < 0.65) spawnMeteor();
    meteorTimer = ts;
  }

  for(let i=meteorList.length-1;i>=0;i--){
    const m = meteorList[i];
    m.life++;
    m.x += m.vx;
    m.y += m.vy;
    const t = 1 - m.life/m.max;
    const a = t*t;

    // æµæ˜Ÿå°¾å·´
    const gx = m.x - m.vx*2.2;
    const gy = m.y - m.vy*2.2;
    const grad = mctx.createLinearGradient(m.x, m.y, gx - m.w, gy - m.w*0.4);
    grad.addColorStop(0, `rgba(255,255,255,${0.85*a})`);
    grad.addColorStop(1, `rgba(107,247,255,0)`);
    mctx.strokeStyle = grad;
    mctx.lineWidth = 2.2;
    mctx.beginPath();
    mctx.moveTo(m.x, m.y);
    mctx.lineTo(gx - m.w, gy - m.w*0.4);
    mctx.stroke();

    // å¤´éƒ¨äº®ç‚¹
    mctx.fillStyle = `rgba(255,255,255,${0.75*a})`;
    mctx.beginPath();
    mctx.arc(m.x, m.y, 2.2, 0, Math.PI*2);
    mctx.fill();

    if(m.life >= m.max || m.x>W+300 || m.y>H+300) meteorList.splice(i,1);
  }

  requestAnimationFrame(meteorLoop);
}
requestAnimationFrame(meteorLoop);

/* ==========================
   7) çƒŸèŠ±å¼•æ“ï¼ˆæ›´é…·ï¼šåŠ æ³•æ··åˆ + bloomæ„Ÿï¼‰
   + èåˆï¼šçˆ†ç‚¸ä¸­å¿ƒéšæœºâ€œç…§ç‰‡å°è®°â€
========================== */
const colors = [
  [255,211,122],[255,99,198],[107,247,255],[255,255,255],[160,255,170],[200,170,255]
];

function rand(a,b){ return a + Math.random()*(b-a); }
function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

const rockets = [];
const sparks = [];
const texts = [];

let PARTICLES = isMobile ? 90 : 140;
let AUTO_RATE = isMobile ? 520 : 420;

class Rocket{
  constructor(x){
    this.x=x;
    this.y=H+10;
    this.vx=rand(-1.2,1.2);
    this.vy=rand(-14.5,-19.5);
    this.ay=0.18;
    this.life=0;
    this.targetY = rand(H*0.16, H*0.42);
    this.color = pick(colors);
    this.trail=[];
  }
  step(){
    this.life++;
    this.vy += this.ay;
    this.x += this.vx;
    this.y += this.vy;

    this.trail.push([this.x,this.y]);
    if(this.trail.length>12) this.trail.shift();

    if(this.y <= this.targetY || this.life>95){
      explode(this.x,this.y,this.color);
      return false;
    }
    return (this.x>-80 && this.x<W+80 && this.y>-80 && this.y<H+80);
  }
  draw(){
    for(let i=0;i<this.trail.length-1;i++){
      const a = i/(this.trail.length-1);
      const p=this.trail[i], q=this.trail[i+1];
      fctx.strokeStyle = `rgba(${this.color[0]},${this.color[1]},${this.color[2]},${0.35*a})`;
      fctx.lineWidth = 2.2;
      fctx.beginPath(); fctx.moveTo(p[0],p[1]); fctx.lineTo(q[0],q[1]); fctx.stroke();
    }
    fctx.fillStyle = `rgba(${this.color[0]},${this.color[1]},${this.color[2]},0.95)`;
    fctx.beginPath(); fctx.arc(this.x,this.y,2.4,0,Math.PI*2); fctx.fill();
  }
}

class Spark{
  constructor(x,y,color){
    this.x=x; this.y=y;
    const ang=rand(0,Math.PI*2);
    const spd=rand(2.2,8.2);
    this.vx=Math.cos(ang)*spd;
    this.vy=Math.sin(ang)*spd;
    this.ay=0.06;
    this.drag=0.985;
    this.life=0;
    this.max=rand(52, 96);
    this.color=color;
    this.r=rand(1.0,2.8);
    this.tw=rand(0.6,1.0);
  }
  step(){
    this.life++;
    this.vx*=this.drag;
    this.vy=this.vy*this.drag + this.ay;
    this.x+=this.vx;
    this.y+=this.vy;
    return this.life < this.max;
  }
  draw(){
    const t=1-this.life/this.max;
    const a=(t*t)*this.tw;
    fctx.fillStyle = `rgba(${this.color[0]},${this.color[1]},${this.color[2]},${a})`;
    fctx.beginPath(); fctx.arc(this.x,this.y,this.r,0,Math.PI*2); fctx.fill();
  }
}

class FloatingText{
  constructor(text,x,y){
    this.text=text;
    this.x=x; this.y=y;
    this.vy=rand(-0.7,-1.25);
    this.life=0; this.max=120;
  }
  step(){ this.life++; this.y+=this.vy; return this.life<this.max; }
  draw(){
    const t=1-this.life/this.max;
    const a=t*t;
    fctx.save();
    fctx.globalAlpha = 0.9*a;
    fctx.font = `900 ${clamp(W/26, 16, 28)}px system-ui,-apple-system,PingFang SC,Microsoft YaHei`;
    fctx.textAlign="center";
    fctx.lineWidth=7;
    fctx.strokeStyle="rgba(255,211,122,0.42)";
    fctx.strokeText(this.text,this.x,this.y);
    fctx.fillStyle="rgba(255,255,255,0.95)";
    fctx.fillText(this.text,this.x,this.y);
    fctx.restore();
  }
}

function floatText(text,x,y){ texts.push(new FloatingText(text,x,y)); }

/* â€”â€” ç…§ç‰‡èåˆï¼šçˆ†ç‚¸ä¸­å¿ƒå°ä¸€ä¸ªâ€œç…§ç‰‡å…‰æ–‘â€ â€”â€” */
const texImgs = [new Image(), new Image()];
texImgs[0].src = ASSETS.img1;
texImgs[1].src = ASSETS.img2;

function drawPhotoStamp(x,y){
  const img = pick(texImgs);
  if(!img.complete) return;

  const size = rand(90, 150);
  fctx.save();
  fctx.globalAlpha = 0.22;
  fctx.translate(x,y);
  fctx.rotate(rand(-0.18,0.18));

  // åœ†å½¢é®ç½©ï¼ˆåƒæŠŠç…§ç‰‡èè¿›çƒŸèŠ±æ ¸å¿ƒï¼‰
  fctx.beginPath();
  fctx.arc(0,0,size*0.46,0,Math.PI*2);
  fctx.clip();

  // åŠ æ³•æ··åˆæ›´æ¢¦å¹»
  fctx.globalCompositeOperation = "screen";
  fctx.drawImage(img, -size/2, -size/2, size, size);

  // å¤–åœˆå¾®å…‰
  fctx.globalCompositeOperation = "lighter";
  const g = fctx.createRadialGradient(0,0,2,0,0,size*0.6);
  g.addColorStop(0,"rgba(255,255,255,0.18)");
  g.addColorStop(1,"rgba(255,255,255,0)");
  fctx.fillStyle = g;
  fctx.beginPath(); fctx.arc(0,0,size*0.6,0,Math.PI*2); fctx.fill();

  fctx.restore();
}

function explode(x,y,color){
  // å…ˆç›–ä¸€å±‚â€œç…§ç‰‡å°è®°â€ä½œä¸ºèåˆï¼ˆæ¦‚ç‡è§¦å‘ï¼‰
  if(Math.random() < 0.55) drawPhotoStamp(x,y);

  const n = PARTICLES + (Math.random()*40|0);
  for(let i=0;i<n;i++) sparks.push(new Spark(x,y,color));

  if(Math.random()<0.65){
    const c2=pick(colors);
    for(let i=0;i<(n*0.5|0);i++) sparks.push(new Spark(x,y,c2));
  }

  // â€œèµ°å¿ƒå¡ç‰‡â€ä»çƒŸèŠ±é‡Œé£˜å‡ºæ¥ï¼ˆæ¦‚ç‡ï¼‰
  if(Math.random() < 0.35){
    floatText(pick(FLOAT_QUOTES), x, y);
  }

  boomSound();
}

function launch(x){
  rockets.push(new Rocket(x));
}

function autoLaunch(){
  launch(rand(W*0.16, W*0.84));
  if(Math.random()<0.35) setTimeout(()=>launch(rand(W*0.12, W*0.88)), 90);
}

function megaBurst(times=20){
  let i=0;
  const id=setInterval(()=>{
    launch(rand(W*0.12, W*0.88));
    i++;
    if(i>=times) clearInterval(id);
  }, 80);
}

$("#mega").addEventListener("click", ()=>{
  megaBurst(isMobile ? 18 : 28);
  floatText(`${HER_NAME}ï¼Œæ–°å¹´å¿«ä¹`, W*0.5, H*0.42);
  ping(1046,0.10,0.10); setTimeout(()=>ping(1318,0.10,0.09),120);
});

/* ç‚¹å“ªå„¿ç‚¸å“ªå„¿ + é•¿æŒ‰åŠ å¯† */
let pressing=false;
let pressTimer=null;
function handlePointer(x,y){
  const count = isMobile ? 2 : 3;
  for(let i=0;i<count;i++){
    const r = new Rocket(clamp(x+rand(-32,32), 10, W-10));
    r.targetY = clamp(y + rand(-90, 50), H*0.14, H*0.55);
    rockets.push(r);
  }
}

window.addEventListener("pointerdown",(e)=>{
  pressing=true;
  handlePointer(e.clientX,e.clientY);
  pressTimer=setInterval(()=>{
    if(!pressing) return;
    handlePointer(e.clientX+rand(-45,45), e.clientY+rand(-25,25));
  }, 160);
},{passive:true});

window.addEventListener("pointerup",()=>{
  pressing=false;
  if(pressTimer) clearInterval(pressTimer);
  pressTimer=null;
},{passive:true});

window.addEventListener("pointercancel",()=>{
  pressing=false;
  if(pressTimer) clearInterval(pressTimer);
  pressTimer=null;
},{passive:true});

/* çƒŸèŠ±ä¸»å¾ªç¯ï¼šæ‹–å½± + è½»å¾® bloom æ„Ÿ */
let lastAuto=0;
function fwLoop(ts){
  // æ‹–å½±ï¼ˆè¶Šå°è¶Šâ€œé•¿å°¾â€ï¼‰
  fctx.fillStyle="rgba(0,0,0,0.20)";
  fctx.fillRect(0,0,W,H);

  // bloomï¼šå åŠ ä¸€å±‚æ·¡æ·¡çš„äº®é›¾ï¼ˆè®©çƒŸèŠ±æ›´â€œè‰³â€ï¼‰
  fctx.save();
  fctx.globalCompositeOperation = "lighter";
  fctx.fillStyle="rgba(255,255,255,0.015)";
  fctx.fillRect(0,0,W,H);
  fctx.restore();

  if(ts-lastAuto>AUTO_RATE){
    autoLaunch();
    lastAuto=ts;
  }

  // rockets
  for(let i=rockets.length-1;i>=0;i--){
    const ok = rockets[i].step();
    rockets[i].draw();
    if(!ok) rockets.splice(i,1);
  }

  // sparks
  fctx.save();
  fctx.globalCompositeOperation = "lighter";
  for(let i=sparks.length-1;i>=0;i--){
    const ok = sparks[i].step();
    sparks[i].draw();
    if(!ok) sparks.splice(i,1);
  }
  fctx.restore();

  // texts
  for(let i=texts.length-1;i>=0;i--){
    const ok = texts[i].step();
    texts[i].draw();
    if(!ok) texts.splice(i,1);
  }

  requestAnimationFrame(fwLoop);
}
requestAnimationFrame(fwLoop);

/* ==========================
   8) ç…§ç‰‡å¡äº¤äº’ï¼šè§¦å‘â€œç…§ç‰‡çƒŸèŠ±â€
========================== */
function photoFireworks(which){
  const x = which===1 ? W*0.22 : W*0.26;
  const y = which===1 ? H*0.30 : H*0.46;
  // è¿å‘ + ä¸“å±æµ®å­—
  for(let i=0;i<8;i++){
    setTimeout(()=>handlePointer(x+rand(-40,40), y+rand(-40,40)), i*90);
  }
  floatText(which===1 ? "æŠŠæ¸©æŸ”è—è¿›å…‰é‡Œ" : "æŠŠå¹¸ç¦ç«¯åœ¨æ‰‹å¿ƒ", W*0.5, H*0.42);
  ping(which===1 ? 988 : 1175, 0.10, 0.10);
}

$("#p1").addEventListener("click", ()=>photoFireworks(1));
$("#p2").addEventListener("click", ()=>photoFireworks(2));

/* ==========================
   9) å¼€åœºï¼šæ›´æƒŠè‰³çš„å…¥åœº
========================== */
function openShow(){
  setPoem(pick(WISHES));
  setTimeout(()=>megaBurst(isMobile?14:22), 260);
  setTimeout(()=>floatText(`${HER_NAME}ï¼Œæ–°å¹´å¿«ä¹`, W*0.5, H*0.42), 720);
  // tip æ·¡å‡º
  setTimeout(()=>{ $("#tip").style.opacity="0"; }, 6500);
}
openShow();
</script>
</body>
</html>
